<h1>Viewing trace <%= @trace.id %></h1>

<script type="text/javascript">
  <!--
  function init(){
    var centre = lonLatToMercator( new OpenLayers.LonLat(0, 53.8));
    var zoom = 6;
    var map = createMap("map", centre, zoom);
    // OpenLayers.Bounds(min_lon, min_lat, max_lon, max_lat);
    var bbox = new OpenLayers.Bounds(<%= @trace.min_lon %>, <%= @trace.min_lat %>, <%= @trace.max_lon %>, <%= @trace.max_lat %>);
    setMapExtent(bbox);
    map.addLayer(new OpenLayers.Layer.GML("KML", "/trace/kml/<%= @trace.id%>", 
        {
        format: OpenLayers.Format.KML, 
        projection: map.displayProjection,
        formatOptions: {
          extractStyles: false, 
          extractAttributes: true,
          maxDepth: 2
        }
        }));
    var SHADOW_Z_INDEX = 9;
    var MARKER_Z_INDEX = 10;

    vectors = new OpenLayers.Layer.Vector("Vector Layer", 
                    { styleMap: new OpenLayers.StyleMap({
                        // Set the external graphic and background graphic images.
                        externalGraphic: "/openlayers/img/marker-gold.png",
                        backgroundGraphic: "/images/marker_shadow.png",
                        
                        // Makes sure the background graphic is placed correctly relative
                        // to the external graphic.
                        backgroundXOffset: 0,
                        backgroundYOffset: -7,
                        
                        // Set the z-indexes of both graphics to make sure the background
                        // graphics stay in the background (shadows on top of markers looks
                        // odd; let's not do that).
                        graphicZIndex: MARKER_Z_INDEX,
                        backgroundGraphicZIndex: SHADOW_Z_INDEX,
                        
                        pointRadius: 10
                        }),
                      projection: new OpenLayers.Projection("EPSG:4326")
                    }
              );
    map.addLayer(vectors);

    controls = {
        point: new OpenLayers.Control.DrawFeature(vectors,
                    OpenLayers.Handler.Point),
        drag: new OpenLayers.Control.DragFeature(vectors, {'onComplete': onCompleteMove})
        //modify: new OpenLayers.Control.ModifyFeature(vectors)
    };

    for(var key in controls) {
        map.addControl(controls[key]);
    }

  }

  function addMarker() {
    controls['point'].activate();
  }  
  
  function onCompleteMove(feature) {
    if(feature) {
      geo = feature.geometry.clone();
      geo.transform(map.getProjectionObject(), map.displayProjection)
      alert(geo.y);
    }
  }
  // -->
</script>
<%= link_to "Upload Another", :action => :upload %>
Original filename: <%= @trace.file_name %><br />
<span onclick="addMarker();">Click to add marker</span><br />
<span onclick="controls['drag'].activate();">Move markers</span>

<div id="map"></div>